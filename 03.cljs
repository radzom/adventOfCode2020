(require '[clojure.string :as str])

(def forest ["...#...#....#....##...###....#."
             "#.#...#...#....#.........#..#.."
             ".#....##..#.#..##..##.........."
             ".....#.#.............#..#......"
             ".......#...#.##.#......#..#.#.."
             "#.#....#......##........##....."
             ".....##.#....#..#...#...##...#."
             "...#...#..#.......#..#...##...#"
             "..........#...........##......."
             "..#..#..#...................#.."
             "#..#....#.....##.#.#..........#"
             ".#.##.......###.....#.#...#...."
             ".#..##....##....#.......#...###"
             "#.#..##...#.#..#..............."
             ".........#....#.......##.#.#..."
             "...###...##....##...#..##.#..#."
             "....#.........#..#...#.......#."
             "....................#..#.#.#..."
             "..#....#..........#...........#"
             ".#.....#..#.....##........##..#"
             "#..##..#...##............#..##."
             ".#..##....#..........#..#.##.#."
             "..#####..#.#............##....."
             "...###.#....##..#.#....#.....#."
             ".#.......##....#...#.#.....##.."
             "...#....#...##.#...#..#........"
             ".####.....#....#.#.#...#......."
             "...#....#.....#.......#........"
             "#..#.#.......#...#............#"
             "...#.....###.##....#.#.###.#..."
             ".#.........#.......#.#....##..."
             "#.#..#...#.#...##......#..#...."
             ".....#...#..#.#...#..###..#...."
             "......#.........#...###........"
             ".....#..##...#..........#.....#"
             "..#..#.#.##.#...#....#....##..#"
             "##....#.##...#.##.#..##....#..."
             ".....#.#.#.#..#....##.#...#.#.."
             ".....##.......#........#......."
             "...#.#.....#...#...##.#......##"
             "........#..#.#...#.#.....#.#..#"
             "#..##...#.#...##..##...#.#...##"
             ".##.#.#..#...#.....#.#.##.#...#"
             ".#.####.........##.........#..#"
             ".##..............#....#...#...#"
             "......#...#..#...#..#..###.#..."
             ".......##...#.#.#..##..#......#"
             ".....#....#..##..#.........#..."
             ".....#..#.#.#........#.#.####.."
             "#..#.......###....##..........."
             "#..##..........#.#......#.#...."
             ".....##........#...#..##......."
             "###...#.##.#.#.#.#.##...##....."
             "....#...#........##.#.##..##..."
             ".#..#.#.#......#.......##..#..#"
             ".#...#.................#....#.."
             ".##..#..........#..##.......#.."
             ".#.#.#.....#..#.#.........##..#"
             "...#......##...#.......#...##.."
             "##...###....#.###.............#"
             "#.....#.#..#.#..#........#.#.#."
             ".....#.#......##..#.#.....#.##."
             ".......#...........#..#.......#"
             "..#....#.#.#......#.....#...#.."
             ".....##........#..##..#..##...."
             "#.#........#...##....#.#..##..."
             "#......#......#....#..#...#.##."
             "....#.#.......#.#.#............"
             "......####.#.##...#.#.##.....##"
             "..###.#.#..#.........#.####...."
             ".#.......#..#.#....#.#..#.#.##."
             "#....#....#............##...##."
             "....#....#............#....#..#"
             "..#........#..#....#..#..#...#."
             ".#......##....#..........#....#"
             "#.##.....#..........#.###.#...."
             "....##...#.....#.#......#.##..."
             "#.#.....#.......###.###..#..#.#"
             "..###..##.............#.####.##"
             "#....#.....#....#..##.......#.."
             ".....#....#...#.#.#.#..#...#.##"
             "...#.....#..#....###......#.#.#"
             "##.........#.#..#..#.#..#.....#"
             ".#.....#.#....#.........##..#.#"
             ".#.#..#.###..#..#..........#..."
             ".##....#.#.#...#......##.....#."
             "#.#....#....#...#...##...#..#.."
             "#...#........#....#....#......#"
             "#......#...#..#.#.##.....##..#."
             "....#...#......##...#..#....#.."
             ".#......##.##.......#.......#.."
             ".#...#..####...........#.#.#..."
             ".........#...#.#.........#....."
             "#.##.....#.#..#.#.###...###..#."
             "#...##.###......#.###..##.#.##."
             "...##.#.....#....#..#......#..."
             "#....###.#..#...##.....#......#"
             "........###...#...#............"
             "........#....#...#...#....#...#"
             "#....#..#..#....#.#........#.#."
             "##...#.....#.#..........#..#..#"
             "#.#...##.....#........#...#...#"
             "##.#.#.......#...#..#.###....#."
             ".#.......#....##..##...#.....#."
             "#....#....#.....#.......#......"
             ".##.##.##...##...#.#.#..#..#..."
             "#..#..#.##....#......##....###."
             ".......#.#.........#..##.#...##"
             ".#..##...#....#.....#.........."
             "..#.#...#......#.#..#.........."
             ".##....#.#.#.##.......###...#.."
             "..##.#...#.#.#.#.......#..#...."
             "#..#.......#...#........#.....#"
             ".....#.......#......###..#....."
             "...##.#.......#.....##.....##.."
             "##..#.......#.#.....#....#....."
             "..#....#.##.##...#...#......#.."
             ".#..#.###.#....###........#...#"
             "....##.##...##..#..#.#....#...."
             "..###...##.....##.............."
             "#....#...##...#....#..........#"
             ".##........#......##...##...#.#"
             "..#.#.##..........#......#....."
             "...#...#.........#.##........##"
             "..#.#..#.#..#...#....#...#....."
             "...##...#..#.###.#..#.#...#...."
             "....###........#..#..##...#...."
             "#.#....##.......#.#........#..."
             ".###...#..#.#.#.#..#...#..##.##"
             "..#.........#####.#......#..#.."
             "#.....#.....##..#....#...#...#."
             "...#..#....##....##.....##.#..."
             ".........#............#.##....."
             "....##.#..#....#.##.......#..##"
             ".###....#.#..#......#.#.......#"
             ".###...###.#.........#.#..#...#"
             ".....#........#..#.#..#.#..##.#"
             ".###..#....##.........#..##...."
             "..#.......#..#..##...#.###.#..."
             "#.......#...........#.#...#.###"
             "#.##.##...##.#...##..#.....#..."
             "..#..#........###.#.....##....."
             "#.....##....#...##...####..#..#"
             "....#........#...#...#........."
             "......#.#.#.#.......#..#.....##"
             "..#..#....#.....#.#...##......#"
             "..#....#...#.###.........#.###."
             "...#......##..#.#.....#...#...."
             "...#.......#...#...#........##."
             "............#...#..#....#.....#"
             "....##......................#.."
             "#.#.#....#....#..........##...."
             "#.#.....#.#.##..#...#.##....##."
             "...#...#..#...#..#.#.#.......#."
             "#.....#..........#.........##.#"
             "#...##..#..#.#.......###....#.."
             ".#...#..##....#.....##.......#."
             "....#.##.....#.........#.#....#"
             "........#.#...####..#.......#.#"
             ".####...#.#......####.....#.##."
             "###..#....#..#.......#.#..##..#"
             "#......#.#....##..#.##.#....#.#"
             "...###...#...#..##.#..#..#.#..."
             "...##..##....#..#.....#........"
             ".....#..............#......#..#"
             "......#....#......#..#........."
             "#..#.....#.##...........##....."
             ".#..#.#..................##...."
             "#.#..#..##...#....#.#......#..."
             ".##.#.##......#.##...#...#...#."
             "..#...#.........#.#..#.#....#.."
             ".#.####.#..#.#......##.#..#...."
             "#..#.......#....#.............."
             "....#............#..#.........."
             ".....#####.....#.....#..##...##"
             "#.#....#.#...............#..##."
             ".#.#..#...#......#.....#.#.#..."
             ".#....#.#.#......#.....##....#."
             "....#....#.##..#.......###...##"
             ".....#..#.##...#...#...#..#.#.."
             "##..#........#.#..#..##......#."
             ".#..#..##.......#..#.....#....."
             ".#.#.....###..##.#.#..........."
             "..##..##.####..........#..#...."
             "..##..#..#...#....#......#.#..."
             "#...#.#......##.....##.#..###.."
             "#..#..............#........##.#"
             ".........#.##..#.#..#..##.##.#."
             "#....##....#.#..#.#...##..#...."
             ".#....#.......#............##.."
             ".......#.#.......#...#.#......#"
             "......##...#.......#.#........#"
             "..###..#.#.##....##...#....##.."
             "..##.##..........##..###......."
             ".#.#.#..#..#.#.......#.#...##.."
             "..#..##.........#.###..#......#"
             "....#.#.#...##.#...#...##..###."
             "..###..##.........##...#...#..#"
             ".#..##...#.......#.......#..#.#"
             "........##....##....#.#.###.#.#"
             "#.....#.#.................#.#.."
             "....#.#.#.....##.####.#......#."
             "....#.......#.#.##.##.........."
             "...#...........#...#.##...#.###"
             "#....#....#..........#.##......"
             "##..#...........##.....##.##..."
             ".#.##...##..##....#..#.....####"
             "#...#...#.##..........##..##..."
             "....##..#....#.....#.#...#....#"
             "..#....#..##...###.#.#........."
             "#......#.#.#...#...#.........#."
             "#............###.#.#.#..##...#."
             ".##.....####...##..##..#..##.#."
             "#..#........#.....#.#.....#...#"
             "#............#....#.#.#........"
             "......##...##.#....#.....#...#."
             "..#........##......#.#.....##.."
             ".#..#..#.....##.......#..#.#..#"
             ".#....#..#....##.#.#.#..#..#.##"
             ".####.#..........#...#..##....."
             "...###..###...##..#............"
             "#..#.....##.#...#..##..#......."
             ".....##....#...###.##...#......"
             "...##..#...#..#..##....##....#."
             "...###....#.###.#.#.##....#...."
             "##.#.#.....#....#.#....#..#...."
             ".......##.....#.#..##...##...#."
             ".#....#.#...##.#..#....#.....#."
             "..#...#..#...#.##........#...#."
             "#....#......##.#....##...#.#..#"
             ".....#..#..#..#......#...#.#.#."
             "..###....#........#...#.......#"
             "###...#.......#.#.......##.##.."
             "......##.....#.#........#....#."
             "#.##..#.#.#.#..#....#.##.....#."
             "..........#.##.#...#...#..#..#."
             "..#...##.#..........#..##.###.."
             "..###..##.##..#.#...##.####..#."
             "#.#.#...............##....###.#"
             "....#.........#.#....#.#....#.#"
             "..#...#.###...#....###.....#..."
             "..#..#....#...#............#..."
             ".#..#....#..##.....##.........."
             "..#....#.#...#.#.#.#.......##.#"
             ".........#....##........#.#...."
             "...#..##.#..#.##...#...#.#....#"
             "....####...#...####.#....###..#"
             "......##...#.##.#.......#..#..."
             "#.#...#.#...#.#...#....#.#.#..."
             ".#.....##...#.....###.#....#..."
             "......##.....###...#.#...#.#..."
             "#..#..##.#.#......#....#..#..#."
             "....#.###.....#..#...#.##.....#"
             "##.##........#......#....#..##."
             "##.....##.#.....#.....##.....#."
             ".....#.##...#.#..#.#.#.....#..."
             ".#.##..#...#.#..#.....#.#......"
             ".....##.......#..#...##..#..#.."
             "#.....#..#.####......#........#"
             ".#..#..##.#..##............#..#"
             ".##..#.#....##.##.....#......#."
             ".......##.........#..#........."
             ".#...#.......................#."
             "#......#.#....##.#.......#..#.."
             "..##..##......#.......#....#.#."
             "##......#......##...##........."
             "..#....####....#.#.....##.#.#.."
             "..........#..#.#.#.....#..#.#.."
             "##..##...........##.......#...."
             "##....#.#....#..#......###....#"
             "...#.#.#..#.......##.......#..."
             "#....#.......#.......#........."
             "...##......##....#...#......#.#"
             "#......#####.#.........#.....#."
             "#..#.............#..#....#...#."
             ".......#.##..#..#..#..#....####"
             "......#.##..##..........###...#"
             ".#.##....###..#........#....##."
             "#......#..#...###.#...#.....#.."
             ".#.#.......#....##.......#.#..."
             "..#.##..#..##.....#.........#.#"
             "#.#...#..#.##....#.......##...."
             ".#.....###....#.#..#...#.....#."
             "#...#..#.......#.#.....##...#.#"
             "#.#####.........#....##.....#.."
             "#....#..##...#....#.##.......#."
             ".#.#.........##....##....#....."
             "...#..##.......#....#.#.#......"
             "#.###.##...###....#.....#.####."
             ".#...#.#.#..##.#..........#...."
             "#.#.....#.##.#..####.....##.#.."
             "...###.##..####.......#......##"
             ".##..#.........#...#.#.....#.##"
             "..#.....##....###.....#.#...##."
             "#....#....#..#....#.##........."
             "......###....#.#..#..#....##..."
             ".#.#................#.......##."
             "...#.......#.........#.#......."
             "...#..........#...##.....###..."
             "....#......#...#..............."
             ".##...#....#.....#.##......#..."
             ".#.....###...##..##...#.#......"
             "....##........#.....#...#....#."
             "#.........#.#...##...#.#..#...."
             "...#.#.....#.#........#.#....#."
             ".#........#.....#.#.#.#.#..#..."
             "....#...#.....#.#....#........#"
             "..###.#....#.#....##...##..#.##"
             ".#....#.#.####.#.#.....#......."
             ".#...#...#.................##.#"
             "..................##..#..#.#.#."
             ".#..#............##....###....."
             ".......#....#...........#......"
             "....#.#.#.....###.........#..##"
             "...#.#....#.#.##.#.##.....##..#"
             ".#.##.#...##...#.......#.....##"
             ".#............#...#..##...#.#.#"
             "#.##..#.##..#..##.###.#........"
             "..............##....#...#..#.#."
             ".#.#...#.#....#....###........#"
             ".#....#.#....#......###........"
             "..#.......##......#.##.....#..."
             ".....#......#..#...#.#.....#..."])

(def start-pos {:right 0 :down 0})

(def slopes [{:right 1 :down 1}
             {:right 3 :down 1}
             {:right 5 :down 1}
             {:right 7 :down 1}
             {:right 1 :down 2}])

(defn step [pos slope]
  {:right (+ (:right pos) (:right slope)) :down (+ (:down pos) (:down slope))})

(defn is-tree-at? 
  [forest pos]
  (let [forest-row (nth forest (pos :down))]
    (= "#" (nth forest-row (mod (pos :right) (count forest-row))))))

(defn count-trees
  [trees forest pos slope]
  (if (< (pos :down) (count forest))
    (+ (if (is-tree-at? forest pos) (inc trees) trees) 
       (count-trees trees forest (step pos slope) slope))
    trees))

(println (count-trees 0 forest start-pos (nth slopes 1))) ;; 162

(println (reduce * (map (partial count-trees 0 forest start-pos) slopes))) ;; 3064612320
